import module "http://marklogic.com/xdmp/tde" at "/MarkLogic/tde.xqy";

let $purchases-second-template := 
  <template xmlns="http://marklogic.com/xdmp/tde">
    <context>/booking</context>
    <vars>
      <var>
        <name>order_date</name>
        <val>date</val>
      </var>
      <var>
        <name>order_id</name>
        <val>@id</val>
      </var>
      <var>
        <name>company</name>
        <val>customer/company</val>
      </var>
    </vars>
    <templates>
      <template>
        <context>line-items/item</context>
        <rows>
          <row>
            <schema-name>customer360</schema-name>
            <view-name>purchases</view-name>
            <columns>
              <column>
                <name>order_date</name>
                <scalar-type>date</scalar-type>
                <val>$order_date</val>
                <invalid-values>ignore</invalid-values>
              </column>
              <column>
                <name>order_id</name>
                <scalar-type>string</scalar-type>
                <val>$order_id</val>
                <invalid-values>ignore</invalid-values>
              </column>
              <column>
                <name>company</name>
                <scalar-type>string</scalar-type>
                <val>$company</val>
                <nullable>true</nullable>
              </column>
              <column>
                <name>product</name>
                <scalar-type>string</scalar-type>
                <val>product</val>
                <invalid-values>ignore</invalid-values>
              </column>
              <column>
                <name>price</name>
                <scalar-type>decimal</scalar-type>
                <val>price</val>
                <invalid-values>ignore</invalid-values>
              </column>
              <column>
                <name>quantity</name>
                <scalar-type>integer</scalar-type>
                <val>quantity</val>
                <invalid-values>ignore</invalid-values>
              </column>
              <column> 
                <name>row_total</name> 
                <scalar-type>decimal</scalar-type> 
                <val>price * quantity</val> 
                <invalid-values>ignore</invalid-values> 
              </column> 
              <column> 
                <name>notes</name> 
                <scalar-type>string</scalar-type> 
                <val>notes</val> 
                <nullable>true</nullable> 
              </column>              
            </columns>
          </row>
        </rows>
      </template>
    </templates>
  </template>

return tde:validate($purchases-second-template)