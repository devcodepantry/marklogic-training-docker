let $purchases-template := 
<template xmlns="http://marklogic.com/xdmp/tde">
  <context>/order</context>
  <vars>
    <var>
      <name>order_date</name>
      <val>order-date</val>
    </var>
    <var>
      <name>order_id</name>
      <val>order-num</val>
    </var>
    <var>
      <name>company</name>
      <val>billing/company</val>
    </var>
  </vars>
  <templates>
    <template>
      <context>items/item</context>
      <rows>
        <row>
          <schema-name>customer360</schema-name>
          <view-name>purchases</view-name>
          <columns>
            <column>
              <name>order_date</name>
              <scalar-type>date</scalar-type>
              <val>$order_date</val>
              <invalid-values>ignore</invalid-values> 
            </column>
            <column>
              <name>order_id</name>
              <scalar-type>string</scalar-type>
              <val>$order_id</val>
              <invalid-values>ignore</invalid-values> 
            </column>
            <column>
              <name>company</name>
              <scalar-type>string</scalar-type>
              <val>$company</val>
              <nullable>true</nullable>
              <invalid-values>ignore</invalid-values> 
            </column>
            <column>
              <name>product</name>
              <scalar-type>string</scalar-type>
              <val>product</val>
              <invalid-values>ignore</invalid-values> 
            </column>
            <column>
              <name>price</name>
              <scalar-type>decimal</scalar-type>
              <val>price</val>
              <invalid-values>ignore</invalid-values> 
            </column>
            <column>
              <name>quantity</name>
              <scalar-type>integer</scalar-type>
              <val>quantity</val>
              <invalid-values>ignore</invalid-values> 
            </column>
            <column>
              <name>row_total</name> 
              <scalar-type>decimal</scalar-type> 
              <val>price * quantity</val> 
              <invalid-values>ignore</invalid-values> 
            </column>
            <column>
              <name>notes</name>
              <scalar-type>string</scalar-type>
              <val>../../notes</val>
              <nullable>true</nullable> 
            </column> 
          </columns>
        </row>
      </rows>
    </template>
  </templates>
</template>

return tde:node-data-extract(fn:doc("/accounting/order-14502.xml"), $purchases-template)